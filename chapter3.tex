% From mitthesis package
% Version: 1.07, 2024/09/26
% Documentation: https://ctan.org/pkg/mitthesis


\chapter{Convex Optimization of Decomposition of Electron-Electron Interaction Hamiltonian Term}

\section{Sparse Hamiltonians}

We would like to identify Hamiltonians for which the double factorization has ``easy'' rotations; that is, each $U_R(u^{(r)})$ decomposes to a small number of basis rotations.

Consider the minimum case: for all $r \in [0, n^2)$, $U_R(u^{(r)}) = I$, which occurs when $u^{(r)} = I$. That is, $Q^{(r)}$ is already diagonal with $\lambda'^{(r)}_s = Q^{(r)}_{s, s}$ and zero basis rotations are necessary. In this case, the Hamiltonian $H_{2e}$ itself can actually be written as a sum of products of number operators. 

\begin{equation}
    \begin{split}
        H_{2e} &= \frac{1}{2}\sum_r\lambda_r\left(\sum_{i,j} Q^{(r)}_{i, j}a^\dag_ia_j\right)^2 \\
        &= \frac{1}{2}\sum_r\lambda_r(\sum_{s} \lambda'^{(r)}_sn_s)^2 \\
        &= \frac{1}{2}\sum_{s, s'} n_sn_{s'}\sum_r\lambda_r\lambda'^{(r)}_s\lambda'^{(r)}_{s'} \\
        &= \frac{1}{2}\sum_s n_s\sum_r\lambda_r(\lambda'^{(r)}_s)^2 + \sum_{s < s'} n_sn_{s'}\sum_r\lambda_r\lambda'^{(r)}_s\lambda'^{(r)}_{s'} \label{eq: collapse}
    \end{split}
\end{equation}

With $H_{2e}$ in the form \eqref{eq: collapse} analogous to \eqref{eq: expansion} in the expansion method, $U_2 = e^{-iH_{2e}t}$ corresponds to a product of $n$ $R_z$ gates and ${n \choose 2}$ $CR_z$ gates, which, just like in the expansion method, costs $O(n^2\log_2(\frac{n}{\epsilon}))$ $T$ gates. Then Trotterization over $H_{2e}$ is not necessary because there is only one term. In such a case, it's unlikely that double factorization will be useful at all, since $H_{2e}$ is already so simple.

More generally, if $H_{2e}$ is very sparse, then a direct brute force Trotterization will not involve as many terms as the worst case $O(n^4)$, and its gate count may be low enough to make double factorization (and thereby the coherent method) unnecessary. At the same time, the coherent method requires the number of rotations composing $u^{(r)}$ to be small, and having very few rotations tends to make $Q^{(r)}$ (and thereby $H_{2e}$) very sparse. Therefore, this opens the problem of finding Hamiltonians $H_{2e}$ that are sufficiently dense but for which the $Q^{(r)}$ are sufficiently easily decomposable.

%We need it to be O(n) rotations but O(n^2) nonzeros in R.

%Example? k-local.

\section{K-Range Hamiltonian}

Define an electronic structure Hamiltonian from \eqref{eq: H3} as $K$-range if its values $h_{ijkl}$ satisfy the following condition.

\begin{equation}
    \begin{split}
        H &= \sum_{i, j} h_{ij}a^\dag_ia_j + \frac{1}{2}\sum_{i,j,k,l} h_{ijkl}a^\dag_ia^\dag_ja_ka_l  \\
        \text{such that } h_{ijkl} &= 0 \text{ if } \min(\max(|i - l|, |j - k|), \max(|i - k|, |j - l|)) > K
    \end{split}
\end{equation}

Any $K$-range Hamiltonian can be rewritten in the following more restrictive form. This is because, for an index $(i, j, k, l)$ such that $\max(|i - k|, |j - l|) > K$ but $\max(|i - l|, |j - k|) \leq K$, we can substitute $h_{ijkl}a^\dag_ia^\dag_ja_la_k = -h_{ijkl}a^\dag_ia^\dag_ja_ka_l$. This term satisfies the more restrictive condition and can be combined with the original term indexed $(i, j, l, k)$. From this process of substitutions and combination we get new terms $\bar{h}_{ijkl}$.

\begin{equation}
    \begin{split}
        H &= \sum_{i, j} h_{ij}a^\dag_ia_j + \frac{1}{2}\sum_{i,j,k,l} \bar{h}_{ijkl}a^\dag_ia^\dag_ja_ka_l \\
        \text{such that } \bar{h}_{ijkl} &= 0 \text{ if } \max(|i - l|, |j - k|) > K
    \end{split}
\end{equation}

Then, accordingly with \eqref{eq: H3}, this Hamiltonian can be rearranged into $H_{1e}$ and $H_{2e}$, and accordingly with \eqref{eq: DF}, $H_{2e}$ can be double factorized. The condition does not change.

\begin{equation}
    \begin{split}
        H_{2e} &= \frac{1}{2}\sum_{i,j,k,l} h'_{iljk}a^\dag_ia_la^\dag_ja_k \\
        &= \frac{1}{2}\sum_r\lambda_r\left(\sum_{i,j} Q^{(r)}_{i, j}a^\dag_ia_j\right)^2 \\
        &= \sum_{r = 0}^{R - 1} H_{2e}^{(r)} \\
        \text{such that } h'_{iljk} &= \bar{h}_{ijkl} = 0 \text{ if } \max(|i - l|, |j - k|) > K
    \end{split}
\end{equation}

Observe that fewer than $K^2n^2$ indices $iljk$ satisfy the range condition, so $H_{2e}$ can be expressed as the sum of $O(K^2n^2)$ Pauli tensor products in context of the brute force method. As one might expect, decreasing $K$ makes $H_{2e}$ sparser.

Observe also that the range condition implies, for all $r$, that $Q^{(r)}_{i, j} = 0$ if $|i - j| > K$. This means that all $Q^{(r)}$ are band matrices with bandwidth $K$.

\begin{equation}
    Q^{(r)} = \begin{bmatrix}
        Q^{(r)}_{0, 0} & \cdots & Q^{(r)}_{0, K} & 0 & \cdots & \cdots & \cdots & \cdots & 0 \\
        \vdots & \ddots & \vdots & Q^{(r)}_{1, K + 1} & \ddots & & & & \vdots \\
        Q^{(r)}_{K, 0} & \cdots & \ddots & \ddots & \ddots & \ddots & & & 0 \\
        0 & Q^{(r)}_{K + 1, 1} & \ddots & \ddots & \ddots & \ddots & \ddots & & 0 \\
        \vdots & \ddots & \ddots & \ddots & \ddots & \ddots & \ddots & \ddots & \vdots \\
        \vdots & & \ddots & \ddots & \ddots & \ddots & \ddots & Q^{(r)}_{n - K - 2, n - 2} & 0 \\
        \vdots & & & \ddots & \ddots & \ddots & \ddots & \cdots & Q^{(r)}_{n - K - 1, n - 1} \\
        \vdots & & & & \ddots & Q^{(r)}_{n - 2, n - K - 2} & \vdots & \ddots & \vdots \\
        0 & \cdots & \cdots & \cdots & \cdots & 0 & Q^{(r)}_{n - 1, n - K - 1} & \cdots & Q^{(r)}_{n - 1, n - 1}
    \end{bmatrix}
\end{equation}

If $Q^{(r)}$ has bandwidth $K$, this guarantees $u^{(r)}$ can be decomposed into at most $Kn$ Givens rotations, corresponding to at most $O(Kn)$ two-qubit basis rotations comprising $U(u^{(r)})$. \textcolor{red}{PROOF?}

Therefore, a $K$-range Hamiltonian can be expressed as a sum of $R$ terms $H_{2e}^{(r)}$, each simulable with either the $O(n^2)$ expansion method or the $O(n(\log{n} + K))$ $T$-gates (we ignore $\epsilon$ factors for simplicity).

\begin{table}[h!]
    \centering
    \renewcommand{\arraystretch}{1.25}
    \begin{tabular}{||c c c c c||} 
        \hline
         & $L$ & $\tilde{N}_T$ & $M = O(L^{1.5})$ & Total $= ML\tilde{N}_T$ \\
        \hline\hline
        Generic $H_{2e}$ & & & & \\
        \hline
        Brute Force & $O(n^4)$ & $O(1)$ & $O(n^6)$ & $O(n^{10})$ \\ 
        DF Expansion Method & $R = O(n^2)$ & $O(n^2)$ & $O(n^3)$ & $O(n^7)$ \\
        DF Coherent Method & $R = O(n^2)$ & $O(n^2)$ & $O(n^3)$ & $O(n^7)$ \\
        \hline\hline
        K-Range & & & & \\
        \hline
        Brute Force & $O(K^2n^2)$ & $O(1)$ & $O(K^3n^3)$ & $O(K^5n^5)$ \\ 
        DF Expansion Method & $R = O(n^2)$ & $O(n^2)$ & $O(n^3)$ & $O(n^7)$ \\
        DF Coherent Method & $R = O(n^2)$ & $O(Kn)$ & $O(n^3)$ & $O(Kn^6)$ \\
        \hline\hline
        Low Rank ($R = O(n)$) & & & & \\
        \hline
        Brute Force & $O(n^4)$ & $O(1)$ & $O(n^6)$ & $O(n^{10})$ \\ 
        DF Expansion Method & $R = O(n)$ & $O(n^2)$ & $O(n^{1.5})$ & $O(n^{5.5})$ \\
        DF Coherent Method & $R = O(n)$ & $O(n^2)$ & $O(n^{1.5})$ & $O(n^{5.5})$ \\
        \hline\hline
        Low Rank and K-Range & & & & \\
        \hline
        Brute Force & $O(K^2n^2)$ & $O(1)$ & $O(K^3n^3)$ & $O(K^5n^5)$ \\ 
        DF Expansion Method & $R = O(n)$ & $O(n^2)$ & $O(n^{1.5})$ & $O(n^{4.5})$ \\
        DF Coherent Method & $R = O(n)$ & $O(Kn)$ & $O(n^{1.5})$ & $O(Kn^{3.5})$ \\
        \hline
    \end{tabular}
    \caption{Asymptotic $T$-count of the brute force, double-factorized expansion method, and double-factorized coherent method on various types of Hamiltonians. We assume a second-order Trotterization. We ignore $\log_2{n}$ terms and $\log_2{\frac{1}{\epsilon}}$ terms for simplicity.}
    \label{table:1}
\end{table}

\section{Decomposition of Hamiltonian Term}

We can expand our usage of this coherent method to electronic structure Hamiltonians that are ``low-rangedly dominant''. These are Hamiltonians that are not themselves low-range but can be expressed as a sum of a low-range term $H_0$ and a relatively small arbitrary-range term $\Delta H$.

\begin{equation}
    \begin{split}
        H &= H_0 + \Delta H \\
        ||\Delta H|| &\ll ||H_0|| \\
    \end{split}
    \label{eq: LRD}
\end{equation}

$e^{-iH_0t}$ is (asymptotically) cheaper, while $e^{-i\Delta Ht}$ is asymptotically more expensive but it affects the output to a lesser extent (since it's smaller). The idea, then, is to use a randomized Hamiltonian simulation algorithm such as qDRIFT, which samples terms more if they have a higher weight (operator norm). In simulating \eqref{eq: LRD}, the algorithm would perform $e^{-iH_0t}$ much more frequently (asymptotically) than $e^{-i\Delta Ht}$, which is good because the former is cheaper. If the operator norm discrepancy $||\Delta H|| \ll ||H_0||$ is large enough, $\Delta H$ will not contribute too much to the overall cost, while still being performed enough times to simulate $H$ precisely.


\section{Gradient Descent}
\section{Gate Count Analysis}
\section{Numerics}


%%%%%%%%%%%%%%%% end table %%%%%%%%%%%%%%%%%%% 

